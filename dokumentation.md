# Документація: зіставлення компаній між двома датасетами

## 1. Підхід до зіставлення

Зіставлення виконується в SQLite через чистий SQL-пайплайн:

1. CSV-файли завантажуються в SQLite (`dataset_1`, `dataset_2`)
2. Для кожного поля (назва, місто, штат/провінція, країна, індекс) виконується поетапна нормалізація в окремих SQL-скриптах
3. Очищені поля об'єднуються у зведені таблиці `ds1_clean_all` та `ds2_clean_all`
4. Зіставлення виконується через `LEFT JOIN` за нормалізованою назвою компанії (`name_clean_ds1 = name_clean_ds2`), що зберігає всі записи з DS1 і підставляє збіги з DS2
5. Збіги за локацією (місто, штат/провінція, індекс) розраховуються як додаткові прапорці, але не впливають на матчинг — компанії зіставляються навіть якщо їхні адреси не збігаються

## 2. Виявлені проблеми з якістю даних

- **Назви компаній**: різний регістр, наявність спецсимволів (`"`, `'`, `*`, `#`, `+`, `-`, `.`, `,`, `_`, `%`, `/`, `&`, дужки), суфікси юридичних форм (INC, LTD, LLC, CORP, CO, COMPANY, LIMITED, CORPORATION, LP), префікси C/O
- **Французькі діакритичні символи**: `É`, `È`, `Ê`, `Ë`, `À`, `Â`, `Ô`, `Î`, `ç` та їхні малі варіанти зустрічаються в назвах, містах та штатах
- **Штати/провінції**: змішані формати — повні назви (ONTARIO, QUEBEC, BRITISH COLUMBIA), скорочення (ON, QC, BC), назви міст замість провінцій (TORONTO, MONTREAL, KRONAU)
- **Країни**: різні позначення (CANADA / CA / CAN, USA / US / UNITED STATES), сміттєві значення (CONTRACT...)
- **Міста**: префікси ST/STE замість SAINT/SAINTE, дефіси, пунктуація
- **Поштові індекси**: пробіли та дефіси всередині кодів (канадські коди виду "K1A 0B1" vs "K1A0B1")
- **Множинні пробіли** у різних полях

## 3. Нормалізація та перетворення

### Назва компанії (name)
1. UPPER + TRIM + COALESCE
2. Видалення частини після C/O
3. Видалення спецсимволів (`"`, `'`, `*`, `#`, `+`, `-`, `,`, `.`, `_`, `%`), заміна `/` та `&` на пробіл
4. Заміна дужок на пробіли
5. Видалення суфіксів юридичних форм: INC, LTD, LIMITED, LP, LLC, CORPORATION, CORP, CO, COMPANY
6. Заміна французьких діакритичних символів на ASCII-еквіваленти
7. Згортання множинних пробілів

### Місто (city)
1. UPPER + TRIM + COALESCE
2. Видалення ком, крапок, лапок
3. Заміна дефісів на пробіли
4. Уніфікація ST -> SAINT, STE -> SAINTE
5. Заміна французьких діакритичних символів
6. Згортання множинних пробілів

### Штат/провінція (state)
1. UPPER + TRIM + COALESCE
2. Заміна французьких діакритичних символів
3. Приведення до 2-літерних кодів провінцій/штатів (повні назви, міста-столиці -> коди)

### Країна (country)
1. UPPER + TRIM + COALESCE
2. Приведення до 2-літерних кодів (CANADA/CAN -> CA, USA/UNITED STATES -> US)
3. Очищення сміттєвих значень

### Поштовий індекс (zip)
1. UPPER + TRIM + COALESCE
2. Видалення пробілів та дефісів

## 4. Розраховані метрики

| Метрика | Значення |
|---|---|
| **Відсоток збігів (match rate)** | 43.52% (457 з 1050 компаній DS1) |
| **Без збігів DS1** | 56.48% (593 компанії) |
| **Без збігів DS2** | 50.21% (471 з 938 компаній DS2) |
| **Загальний % без збігів** | 53.52% (1064 з 1988 унікальних компаній обох датасетів) |
| **Збіги «один до багатьох»** | 15.10% (69 компаній DS1 зіставлені з кількома з DS2) |
| **Збіг за містом** | 75.75% серед зіставлених пар |
| **Збіг за штатом** | 89.75% серед зіставлених пар |
| **Збіг за індексом** | 66.54% серед зіставлених пар |

## 5. Структура проєкту

```
run.py                  — основний скрипт (завантаження CSV + виконання SQL + експорт CSV)
data/
  company_dataset_1.csv — вихідний датасет 1
  company_dataset_2.csv — вихідний датасет 2
  merged_dataset.csv    — об'єднаний результат
  metrics.csv           — метрики
sql/
  ds1_clean_name.sql    — нормалізація назв DS1
  ds2_clean_name.sql    — нормалізація назв DS2
  ds1_clean_city.sql    — нормалізація міст DS1
  ds2_clean_city.sql    — нормалізація міст DS2
  ds1_clean_state.sql   — нормалізація штатів DS1
  ds2_clean_state.sql   — нормалізація штатів DS2
  ds1_clean_country.sql — нормалізація країн DS1
  ds2_clean_country.sql — нормалізація країн DS2
  ds1_clean_zip.sql     — нормалізація індексів DS1
  ds2_clean_zip.sql     — нормалізація індексів DS2
  ds1_clean_all.sql     — зведена таблиця DS1
  ds2_clean_all.sql     — зведена таблиця DS2
  matching.sql          — зіставлення (LEFT JOIN за назвою)
  metrics.sql           — розрахунок метрик
```
